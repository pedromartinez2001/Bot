/** 
* NO TOCAR ESTE ARCHIVO: Es generado automaticamente, si sabes lo que haces adelante ;)
* de lo contrario mejor ir a la documentacion o al servidor de discord link.codigoencasa.com/DISCORD
*/
'use strict';

var require$$0 = require('mongodb');

const { MongoClient } = require$$0;

class MongoAdapter {
    db
    listHistory = []
    credentials = { dbUri: null, dbName: null }
    constructor(_credentials) {
        this.credentials = _credentials;
        this.init().then();
    }

    init = async () => {
        try {
            const client = new MongoClient(this.credentials.dbUri, {});
            await client.connect();
            console.log('ðŸ†— ConexiÃ³n Correcta DB');
            const db = client.db(this.credentials.dbName);
            this.db = db;
            return true
        } catch (e) {
            console.log('Error', e);
            return
        }
    }

    // Guardar una orden en la colecciÃ³n 'orders'
    saveOrder = async (order) => {
        const { name, phone, delivery, location, items } = order;

        // ValidaciÃ³n bÃ¡sica
        if (!name || !phone || typeof delivery === 'undefined' || !Array.isArray(items)) {
            throw new Error("Faltan datos obligatorios o son incorrectos.");
        }

        if (delivery && !location) {
            throw new Error("La ubicaciÃ³n es obligatoria para Ã³rdenes de delivery.");
        }

        // Estructura de la orden
        const orderToSave = {
            name,
            phone,
            delivery,
            location,
            items,
            createdAt: new Date()
        };

        try {
            const result = await this.db.collection('orders').insertOne(orderToSave);
            console.log("âœ… Orden guardada:", result.insertedId);
            return result.insertedId;
        } catch (err) {
            console.error("âŒ Error al guardar la orden:", err.message);
            throw err;
        }
    };

    // Obtener todas las Ã³rdenes
    getOrders = async () => {
        try {
            const orders = await this.db.collection('orders').find().toArray();
            return orders;
        } catch (err) {
            console.error("âŒ Error al obtener Ã³rdenes:", err.message);
            throw err;
        }
    };

    // Obtener una orden por ID
    getOrderById = async (orderId) => {
        try {
            const order = await this.db.collection('orders').findOne({ _id: require('mongodb').ObjectId(orderId) });
            if (!order) throw new Error("Orden no encontrada.");
            return order;
        } catch (err) {
            console.error("âŒ Error al obtener la orden:", err.message);
            throw err;
        }
    };

    getPrevByNumber = async (from) => {
        const result = await this.db.collection('history').find({ from }).sort({ _id: -1 }).limit(1).toArray();
        return result[0]
    }

    save = async (ctx) => {
        const ctxWithDate = {
            ...ctx,
            date: new Date(),
        };
        await this.db.collection('history').insertOne(ctxWithDate);

        this.listHistory.push(ctx);
    }
}

var mongo = MongoAdapter;

module.exports = mongo;
